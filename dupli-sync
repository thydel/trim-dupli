#!/usr/bin/make -f

MAKEFLAGS += -Rr
SHELL != which bash
.DEFAULT_GOAL := help

include /etc/local/duply-local.mk
$(if $(secondary.backup),,$(error secondary.backup undefined))

BWP ?= 12
BWL != echo 2^$(BWP) | bc

store      := /var/local/duplicity/store
key        := /root/.ssh/duplicity-rsync

rsync.ssh  := -e 'ssh -i $(key)'
rsync.bwl  := --bwlimit=$(BWL)k
rsync.args  = -avRP$(DRY) --no-i-r --delay-updates
rsync       = $(if $(TIME),time) rsync "$(rsync.ssh)" $(rsync.bwl) $(rsync.args)
rsync      += $(store)/./{} $(secondary.backup)::duplicity
main        = xargs -i echo 'echo {}; echo; $(rsync); echo' $(RUN)

time := TIME := T
dry  := DRY  := n
run   = RUN  := | $(if $(TIME),time) dash |& cat

vartar := time dry run
$(vartar):; @: $(eval $($@))

define help
echo dupli sync [time] [dry] [run] main
endef

main help:; @$($@)

.PHONY: help $(vartar)
